<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>JS / CSS Filters</title>
<style>
    :root {
        --slider-size: 20px;
    }

    body {
        display: grid;
        grid-template-areas: 'originalImage filteredImage' 'filterControl filterControl' 'buttons buttons';
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: auto auto 50px;
        grid-column-gap: 10px;
        text-align: center;
    }

    #original-image-wrapper {
        grid-area: originalImage;
    }

    #filtered-image-wrapper {
        grid-area: filteredImage;
    }

    #filters {
        grid-area: filterControl;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-column-gap: 20px;
    }

    .filter {
        display: grid;
        grid-template-areas: 'title resetBtn' 'slider slider';
        grid-template-columns: repeat(2, 1fr);
        align-items: center;
    }

    .filter h2 {
        grid-area: title;
        font-size: 1em;
    }

    canvas {
        display: none;
    }

    img {
        width: 100%;
        height: auto;
    }

    .filter input {
        grid-area: slider;
        -webkit-appearance: none;
        width: 100%;
        height: var(--slider-size);
        border: none;
        border-radius: 20px;
        background: #970000;
    }
    input::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: var(--slider-size);
        width: var(--slider-size);
        background-color: #0faaaa;
        border-radius: 50%;
    }

    .reset-button {
        grid-area: resetBtn;
    }

    #buttons {
        grid-area: buttons;
    }

    button {
        width: 80%;
        height: 80%;
        border: none;
        border-radius: 20px;
        background-color: #376fe7;
        color: #d8e5e7;
    }

    button:hover {
        background-color: #0d3faa;
    }
</style>

<script>
// Default image
const imgURL = "https://source.unsplash.com/random/400x200";

// Filter format:
const cssFilters = [];

// Global variable used for consistent URLs
var img = new Image();
img.crossOrigin = ""; 
img.src = imgURL;

// Global variable
const appliedFilters = [];

const createFilterSliderNode = (filter) => {
    // Filter node (parent)
    const filterNode = document.createElement("div");
    filterNode.className = "filter";

    // Title node
    const nodeTitle = document.createElement("h2");
    nodeTitle.setAttribute("id", `${filter.name}-title`)
    const titleText = document.createTextNode(`${filter.name}: ${filter.default} ${filter.measurement}`);
    nodeTitle.appendChild(titleText);
    filterNode.appendChild(nodeTitle);

    // Slider node
    const sliderNode = document.createElement("input");
    sliderNode.className = "slider";
    sliderNode.setAttribute("type", "range");
    sliderNode.setAttribute("min", filter.min);
    sliderNode.setAttribute("max", filter.max);
    sliderNode.setAttribute("value", filter.default);
    sliderNode.setAttribute("name", filter.name);
    sliderNode.setAttribute("onchange", `applyFilter(this, '${filter.measurement}')`);
    filterNode.appendChild(sliderNode);

    // Reset button node
    const resetNode = document.createElement("button");
    const resetText = document.createTextNode("Reset");
    resetNode.appendChild(resetText);
    resetNode.setAttribute("onclick", `resetFilter('${filter.name}')`);
    resetNode.className = "reset-btn";
    filterNode.appendChild(resetNode);

    document.querySelector("#filters").append(filterNode);
}

const applyFilter = (filterNode, filterMeasurement) => {
    const canvas = document.querySelector("canvas");
    canvas.width = img.width;
    canvas.height = img.height;

    const ctx = canvas.getContext("2d");

    // update applied filters
    if (typeof ctx.filter !== "undefined") {
        const filterIndex = appliedFilters.findIndex(filter => filter.name === filterNode.name);
        if(filterIndex === -1) {
            appliedFilters.push({name: filterNode.name, value: filterNode.value, measurementSymbol: filterMeasurement});
        } else {
            appliedFilters[filterIndex].value = filterNode.value;
        }
    }

    // apply filter
    ctx.filter = "none";
    appliedFilters.forEach(filter => {
        if(ctx.filter == 'none') {
            ctx.filter = (`${filter.name}(${filter.value}${filter.measurementSymbol})`);
        } else {
            ctx.filter += (` ${filter.name}(${filter.value}${filter.measurementSymbol})`);
        }
    });
    
    // Update slider title text
    document.getElementById(`${filterNode.name}-title`).innerText = `${filterNode.name}: ${filterNode.value} ${filterMeasurement}`;

    ctx.drawImage(img, 0, 0);

    document.querySelector("#filteredImage").src = canvas.toDataURL();
}

const populateCSSFilters = () => {
    cssFilters.push({
        name: 'blur',
        default: 0,
        min: 0,
        max: 10,
        measurement: 'px'
    });
    cssFilters.push({
        name: 'brightness',
        default: 100,
        min: 0,
        max: 200,
        measurement: '%'
    });
    cssFilters.push({
        name: 'contrast',
        default: 100,
        min: 0,
        max: 200,
        measurement: '%'
    });
    cssFilters.push({
        name: 'grayscale',
        default: 0,
        min: 0,
        max: 150,
        measurement: '%'
    });
    cssFilters.push({
        name: 'hue-rotate',
        default: 0,
        min: 0,
        max: 360,
        measurement: 'deg'
    });
    cssFilters.push({
        name: 'invert',
        default: 0,
        min: 0,
        max: 100,
        measurement: '%'
    });
    cssFilters.push({
        name: 'opacity',
        default: 100,
        min: 0,
        max: 100,
        measurement: '%'
    });
    cssFilters.push({
        name: 'saturate',
        default: 100,
        min: 0,
        max: 500,
        measurement: '%'
    });
    cssFilters.push({
        name: 'sepia',
        default: 0,
        min: 0,
        max: 100,
        measurement: '%'
    });
}

const resetFilter = (filterName) => {
    const filter = cssFilters.find(filter => filter.name === filterName);
    const node = Array.from(document.querySelectorAll('.slider')).find(node => node.name === filterName);
    node.value = filter.default;

    applyFilter(node, filter.measurement);
}

const resetAllFilters = () => {
    cssFilters.forEach(filter => {
        resetFilter(filter.name);
    });
}

window.onload = function() {
    document.querySelector("#originalImage").src = img.src;
    document.querySelector("#filteredImage").src = img.src;

    populateCSSFilters();

    cssFilters.forEach(filter => {
        createFilterSliderNode(filter);
    })
}

</script>
</head>
<body>
    <!-- Canvas is used to change image properties, and is not displayed -->
    <canvas></canvas>
    <div id="original-image-wrapper">
        <h1>Original Image</h1>
        <img id="originalImage">
    </div>
    <div id="filtered-image-wrapper">
        <h1>Filtered Image</h1>
        <img id="filteredImage">
    </div>
    <!-- JS populates #filters with individual filters -->
    <div id="filters">
    </div>
    <div id="buttons">
        <button onclick="resetAllFilters()">Reset All Filters</button>
    </div>
</body>
</html>